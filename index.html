<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script src="https://cdn.jsdelivr.net/npm/signature_pad"></script>
		<title>Entregar Certificado - Narvaezbid</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 0;
				padding: 0;
				background-color: #1c1c3c;
				color: #dfdfdf;
			}
			h2 {
				text-align: center;
				margin: 10px 0 0 0;
			}
			.campos {
				margin: 10px;
				padding: 10px;
				background-color: #2c2c5c;
				border-radius: 10px;
				font-size: 25px;
			}

			#apellido,
			#nombre,
			#dni {
				font-weight: bold;
			}
			#video-container {
				position: relative;
				display: inline-block;
				display: flex;
				justify-content: center;
				align-items: center;
			}
			#recuadro {
				position: absolute;
				top: 50%;
				left: 50%;
				width: 250px;
				height: 80px;
				background-color: transparent;
				border: 1px solid white;
				transform: translate(-50%, -50%);
				pointer-events: none;
				display: none;
			}
			video {
				/* display: block;
				width: 100%;
				height: 350px;
				max-width: 350px; */

				display: block;
				width: 100%;
				height: auto;
				max-width: 400px; /* Aumentamos el ancho mÃ¡ximo */
				max-height: 250px; /* Reducimos la altura */
				object-fit: cover;
			}
			.buttons {
				display: flex;
				justify-content: center;
				align-items: center;
				margin: 5px;
			}
			#btnEscanear {
				font-family: Arial, Helvetica, sans-serif;
				background-color: transparent;
				border-radius: 50px;
				padding: 10px 10px;
				border: 1px solid #be00ff;
				min-width: 270px;
				margin: 5px;
				transition: all 0.2s ease;

				cursor: pointer;
				color: white;
				font-size: 35px;
			}

			#btnEscanear:hover,
			#btnInstructivo:hover,
			#btnAceptar:hover,
			#btnBorrar:hover,
			#btnCancelar:hover {
				background-color: #be00ff;
				color: white;
			}
			#btnEscanear,
			#btnLinterna {
				margin: 5px;
			}
			#btnLinterna {
				padding: 10px 10px;
				font-family: Arial, Helvetica, sans-serif;
				background-color: transparent;
				border-radius: 50px;
				border: 1px solid #be00ff;
				transition: all 0.2s ease;
				margin: 5px;
				cursor: pointer;
				color: white;
				font-size: 35px;
			}
			.btnInstructivo-box {
				display: flex;
				justify-content: center;
			}
			#btnInstructivo,
			#btnAceptar,
			#btnBorrar,
			#btnCancelar {
				padding: 10px 10px;
				font-family: Arial, Helvetica, sans-serif;
				background-color: transparent;
				border-radius: 50px;
				border: 1px solid #be00ff;
				transition: all 0.2s ease;
				margin: 5px;
				cursor: pointer;
				color: white;
				font-size: 16px;
			}
			/* MODAL */
			.modal {
				display: none;
				position: fixed;
				z-index: 1;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				overflow: auto;
				background-color: rgba(0, 0, 0, 0.7);
			}

			.modal-header {
				display: flex;
				justify-content: center;
				align-items: center;
				margin-bottom: 15px;
			}
			.modal-content {
				background-color: #2c2c5c;
				margin: 15% auto;
				padding: 20px;
				border: 1px solid #be00ff;
				width: 80%;
				max-width: 500px;
				text-align: center;
				border-radius: 10px;
			}
			.close {
				color: #aaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
				cursor: pointer;
				margin-top: -10px;
			}

			.close:hover,
			.close:focus {
				color: white;
				text-decoration: none;
			}
			.modal img {
				width: 100%;
				border-radius: 10px;
			}

			/* Firma */
			#signature-container {
				display: none;
				/* border: 2px solid #000; */
				width: 100%;
				max-width: 370px;
				text-align: center;
				/* background-color: #2c2c5c; */
				justify-content: center;
				align-items: center;
				flex-direction: column;
				border-radius: 10px;
				margin: 0 auto;
			}
			#signature-pad {
				border: 1px solid #be00ff;
				width: 100%;
				height: 220px;
			}
			.firmatitle {
				display: flex;
				justify-content: center;
				align-items: center;
			}
			#firma-guardada {
				margin-top: 0px;
				display: none;
			}
			#firma-imagen {
				max-width: 370px;
			}
		</style>
	</head>
	<body>
		<h2>Entregar certificado de Subasta</h2>
		<div class="btnInstructivo-box">
			<button id="btnInstructivo">Instructivo</button>
		</div>

		<div id="video-container">
			<video id="video" style="display: none" autoplay></video>
			<div id="recuadro"></div>
		</div>

		<div class="campos">
			<!-- <p><strong>Resultado:</strong> <span id="resultado"></span></p> -->
			<p>Apellido: <span id="apellido"></span></p>
			<p>Nombre: <span id="nombre"></span></p>
			<p>DNI: <span id="dni"></span></p>
			<!-- <p><strong>Fecha EmisiÃ³n:</strong> <span id="fechaEmision"></span></p> -->
			<!-- Imagen de la firma guardada -->
			<div id="firma-guardada">
				<h4>Firma:</h4>
				<img id="firma-imagen" src="" alt="Firma" />
			</div>
		</div>
		<div class="buttons">
			<button id="btnEscanear">Escanear DNI</button>
			<button id="btnLinterna" style="display: none">ðŸ”¦</button>
		</div>
		<!-- Contenedor de firma -->
		<div id="signature-container">
			<div class="firmatitle">
				<h3>Firma Digital</h3>
				<svg
					fill="#ffffff"
					height="64px"
					width="64px"
					version="1.1"
					id="Layer_1"
					xmlns="http://www.w3.org/2000/svg"
					xmlns:xlink="http://www.w3.org/1999/xlink"
					viewBox="0 0 512 512"
					xml:space="preserve"
					stroke="#ffffff"
				>
					<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
					<g
						id="SVGRepo_tracerCarrier"
						stroke-linecap="round"
						stroke-linejoin="round"
					></g>
					<g id="SVGRepo_iconCarrier">
						<g>
							<g>
								<path
									d="M501.801,179.563h-33.023c3.145-11.057,1.345-23.229-5.394-33.004l13.011-13.011c1.912-1.913,2.987-4.507,2.987-7.212 c0-2.214-0.73-4.348-2.041-6.1l22.875-22.875c1.912-1.912,2.987-4.507,2.987-7.212s-1.075-5.298-2.987-7.212l-18.371-18.371 c-1.912-1.912-4.507-2.987-7.212-2.987s-5.3,1.075-7.212,2.987l-22.875,22.875c-3.995-2.993-9.681-2.685-13.313,0.946 l-91.176,91.176H10.199C4.566,179.564,0,184.131,0,189.763v250.458c0,5.632,4.566,10.199,10.199,10.199h491.602 c5.633,0,10.199-4.567,10.199-10.199V189.762C512,184.129,507.434,179.563,501.801,179.563z M474.633,86.203l3.947,3.946 l-15.581,15.58l-3.946-3.946L474.633,86.203z M438.445,110.023l16.313,16.313L280.372,300.721l-16.313-16.313L438.445,110.023z M446.481,179.563H430.38l18.053-18.053C450.886,167.374,450.231,174.228,446.481,179.563z M265.948,315.145l-39.423,39.422 c-1.874,1.875-4.365,2.908-7.016,2.908c-2.651,0-5.142-1.033-7.017-2.909l-2.28-2.279c-3.869-3.869-3.869-10.164,0-14.032 l39.423-39.423L265.948,315.145z M491.602,430.021H20.398V199.962H319.66L195.789,323.833c-9.713,9.714-11.437,24.428-5.19,35.927 l-8.165,8.165H64.534c-5.633,0-10.199,4.567-10.199,10.199s4.566,10.199,10.199,10.199h122.124c3.018,0,5.721-1.318,7.588-3.4 l10.766-10.729c4.397,2.401,9.348,3.68,14.497,3.68c8.099,0,15.713-3.155,21.44-8.881l169.031-169.031h16.524l-34.789,34.789 c-3.983,3.983-3.983,10.441,0,14.425c1.992,1.991,4.602,2.987,7.212,2.987c2.61,0,5.221-0.996,7.212-2.987l49.214-49.214h36.248 V430.021z"
								></path>
							</g>
						</g>
						<g>
							<g>
								<path
									d="M408.138,367.924h-74.516c-5.633,0-10.199,4.567-10.199,10.199s4.566,10.199,10.199,10.199h74.516 c5.633,0,10.199-4.567,10.199-10.199S413.77,367.924,408.138,367.924z"
								></path>
							</g>
						</g>
						<g>
							<g>
								<path
									d="M451.605,367.924h-6.209c-5.633,0-10.199,4.567-10.199,10.199s4.566,10.199,10.199,10.199h6.209 c5.633,0,10.199-4.567,10.199-10.199S457.238,367.924,451.605,367.924z"
								></path>
							</g>
						</g>
						<g>
							<g>
								<path
									d="M186.659,231.311H64.534c-5.633,0-10.199,4.567-10.199,10.199c0,5.632,4.566,10.199,10.199,10.199h122.124 c5.633,0,10.199-4.567,10.199-10.199C196.858,235.878,192.292,231.311,186.659,231.311z"
								></path>
							</g>
						</g>
						<g>
							<g>
								<path
									d="M186.659,275.814H64.534c-5.633,0-10.199,4.567-10.199,10.199s4.566,10.199,10.199,10.199h122.124 c5.633,0,10.199-4.567,10.199-10.199S192.292,275.814,186.659,275.814z"
								></path>
							</g>
						</g>
					</g>
				</svg>
			</div>

			<canvas id="signature-pad"></canvas>
			<div class="buttons">
				<button id="btnAceptar">Aceptar</button>
				<button id="btnBorrar">Borrar</button>
				<!-- <button id="btnCancelar">Cancelar</button> -->
			</div>
		</div>

		<div id="modal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<div class="modal-header">
					<!-- <svg
						width="46px"
						height="46px"
						viewBox="0 0 48 48"
						xmlns="http://www.w3.org/2000/svg"
						fill="#ffffff"
					>
						<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
						<g
							id="SVGRepo_tracerCarrier"
							stroke-linecap="round"
							stroke-linejoin="round"
						></g>
						<g id="SVGRepo_iconCarrier">
							<defs>
								<style>
									.a {
										fill: none;
										stroke: #ffffff;
										stroke-linecap: round;
										stroke-linejoin: round;
									}
								</style>
							</defs>
							<rect
								class="a"
								x="5.6751"
								y="10.9786"
								width="36.6498"
								height="26.0429"
								rx="3"
							></rect>
							<circle class="a" cx="14.8376" cy="21.4867" r="3.5632"></circle>
							<path
								class="a"
								d="M10.3276,31.0945h9.7835a.92.92,0,0,0,.6994-1.5192,7.1719,7.1719,0,0,0-11.1823,0,.92.92,0,0,0,.6994,1.5192Z"
							></path>
							<line
								class="a"
								x1="28.7085"
								y1="20.8504"
								x2="35.7076"
								y2="20.8504"
							></line>
							<line
								class="a"
								x1="28.7085"
								y1="27.7222"
								x2="35.7076"
								y2="27.7222"
							></line>
							<line class="a" x1="28.7085" y1="24.2863" x2="38.38" y2="24.2863"></line>
						</g>
					</svg> -->
					<h2>Escanear DNI</h2>
				</div>

				<img src="dniformat.png" alt="Instructivo" />
			</div>
		</div>
		<script type="module">
			import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm";

			const codeReader = new BrowserMultiFormatReader();
			const videoElement = document.getElementById("video");
			const resultadoElement = document.getElementById("resultado");
			const btnEscanear = document.getElementById("btnEscanear");
			const btnLinterna = document.getElementById("btnLinterna");
			const recuadro = document.getElementById("recuadro");

			const apellidoElement = document.getElementById("apellido");
			const nombreElement = document.getElementById("nombre");
			const dniElement = document.getElementById("dni");
			const fechaEmisionElement = document.getElementById("fechaEmision");

			let stream = null;
			let track = null;
			let linternaEncendida = false;

			btnEscanear.addEventListener("click", () => {
				btnEscanear.style.display = "none";
				navigator.mediaDevices
					.getUserMedia({
						video: {
							facingMode: "environment",
							width: { ideal: 1920 }, // Aumenta la resoluciÃ³n
							height: { ideal: 1080 },
						},
					})
					.then((s) => {
						stream = s;
						videoElement.srcObject = stream;
						videoElement.style.display = "block";
						videoElement.play();
						btnLinterna.style.display = "inline";
						track = stream.getVideoTracks()[0];
						recuadro.style.display = "block";

						codeReader.decodeFromVideoDevice(
							undefined,
							videoElement,
							(result, err) => {
								if (result) {
									const datos = result.text; // El texto del QR
									const partes = datos.split("@");

									// Creamos un objeto para almacenar los valores detectados
									let apellido = "";
									let nombre = "";
									let dni = "";
									let fechaNacimiento = "";
									let fechaEmision = "";
									let codigoExtra = ""; // El campo adicional en el segundo formato

									// Verificamos cuÃ¡ntas partes tiene el array
									if (partes.length === 8) {
										// Caso 1: Formato con 8 partes
										apellido = partes[1] || "Apellido no detectado";
										nombre = partes[2] || "Nombre no detectado";
										dni = partes[4] || "DNI no detectado";
										fechaNacimiento = partes[6] || "Fecha de nacimiento no disponible";
										fechaEmision = partes[7] || "Fecha de emisiÃ³n no disponible";
									} else if (partes.length === 9) {
										// Caso 2: Formato con 9 partes
										apellido = partes[1] || "Apellido no detectado";
										nombre = partes[2] || "Nombre no detectado";
										dni = partes[4] || "DNI no detectado";
										fechaNacimiento = partes[6] || "Fecha de nacimiento no disponible";
										fechaEmision = partes[7] || "Fecha de emisiÃ³n no disponible";
										codigoExtra = partes[8] || "CÃ³digo adicional no disponible";
									} else {
										console.error("Formato del cÃ³digo QR inesperado");
									}

									// Mostrar los resultados
									apellidoElement.textContent = apellido;
									nombreElement.textContent = nombre;
									dniElement.textContent = dni;
									// fechaEmisionElement.textContent = fechaEmision;
									// document.getElementById("fechaNacimiento").textContent = fechaNacimiento;

									// Si hay un cÃ³digo extra en el segundo formato, lo mostramos
									if (codigoExtra) {
										console.log("CÃ³digo adicional:", codigoExtra);
									}

									console.log("CÃ³digo detectado:", datos);
									detenerEscaneo();
									codeReader.reset();
									document.getElementById("signature-container").style.display = "flex";
								}
							}
						);
					})
					.catch((err) => console.error("Error accediendo a la cÃ¡mara:", err));
			});

			btnLinterna.addEventListener("click", () => {
				if (track) {
					linternaEncendida = !linternaEncendida;
					track
						.applyConstraints({ advanced: [{ torch: linternaEncendida }] })
						.then(() =>
							console.log(`Linterna ${linternaEncendida ? "encendida" : "apagada"}`)
						)
						.catch((err) => console.error("No se pudo activar la linterna:", err));
				}
			});

			function detenerEscaneo() {
				if (stream) {
					stream.getTracks().forEach((track) => track.stop());
					stream = null;
				}

				videoElement.srcObject = null;
				videoElement.style.display = "none";
				btnLinterna.style.display = "none";
				btnEscanear.style.display = "none";
				linternaEncendida = false;
				recuadro.style.display = "none";
				console.log("CÃ¡mara apagada y escaneo detenido.");
				// alert("Escaneo completado, cÃ¡mara apagada.");
			}

			document
				.getElementById("btnInstructivo")
				.addEventListener("click", function () {
					document.getElementById("modal").style.display = "block";
				});

			document.querySelector(".close").addEventListener("click", function () {
				document.getElementById("modal").style.display = "none";
			});

			window.addEventListener("click", function (event) {
				if (event.target === document.getElementById("modal")) {
					document.getElementById("modal").style.display = "none";
				}
			});

			// Firma

			document
				.getElementById("btnAceptar")
				.addEventListener("click", saveSignature);
			document
				.getElementById("btnBorrar")
				.addEventListener("click", clearSignature);
			// document.getElementById("btnCancelar").addEventListener("click", quitSignature);
			let signaturePad;
			let firmaBase64 = "";

			window.onload = function () {
				const canvas = document.getElementById("signature-pad");
				ajustarTamanioCanvas(canvas); // Ajustamos el tamaÃ±o correctamente
				signaturePad = new SignaturePad(canvas, {
					backgroundColor: "transparent",
					penColor: "#dfdfdf", // Cambio de color del trazo
				});
			};
			// FunciÃ³n para asegurar que el canvas tenga el tamaÃ±o correcto
			function ajustarTamanioCanvas(canvas) {
				const ratio = Math.max(window.devicePixelRatio || 1, 1);
				canvas.width = 370 * ratio; // Multiplicamos por el ratio del dispositivo
				canvas.height = 220 * ratio;
				canvas.getContext("2d").scale(ratio, ratio); // Escalamos para evitar desfasajes
			}

			// Borrar firma
			function clearSignature() {
				signaturePad.clear();
			}

			// Guardar firma
			function saveSignature() {
				if (!signaturePad.isEmpty()) {
					firmaBase64 = signaturePad.toDataURL();
					document.getElementById("firma-imagen").src = firmaBase64;
					document.getElementById("firma-guardada").style.display = "block";
					document.getElementById("signature-container").style.display = "none";
				} else {
					alert("Debes firmar antes de aceptar.");
				}
			}

			function quitSignature() {
				document.getElementById("signature-container").style.display = "none";
			}
		</script>
	</body>
</html>
