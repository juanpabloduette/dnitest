<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esc치ner DNI Argentina</title>
</head>
<body>
    <h2>Escanea el c칩digo de barras del DNI</h2>
    <button id="btnEscanear">Escanear DNI</button>
    <button id="btnLinterna" style="display: none;">游댡 Linterna</button>
    <video id="video" style="width: 100%; max-width: 400px; display: none;" autoplay></video>
    <p><strong>Resultado:</strong> <span id="resultado"></span></p>
    <p><strong>Apellido:</strong> <span id="apellido"></span></p>
    <p><strong>Nombre:</strong> <span id="nombre"></span></p>
    <p><strong>DNI:</strong> <span id="dni"></span></p>
    <p><strong>Fecha Emisi칩n:</strong> <span id="fechaEmision"></span></p>

    <script type="module">
        import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm';

        const codeReader = new BrowserMultiFormatReader();
        const videoElement = document.getElementById("video");
        const resultadoElement = document.getElementById("resultado");
        const btnEscanear = document.getElementById("btnEscanear");
        const btnLinterna = document.getElementById("btnLinterna");

        // Elementos donde se mostrar치n los valores extra칤dos
        const apellidoElement = document.getElementById("apellido");
        const nombreElement = document.getElementById("nombre");
        const dniElement = document.getElementById("dni");
        const fechaEmisionElement = document.getElementById("fechaEmision");

        let stream = null;
        let track = null;
        let linternaEncendida = false;

        btnEscanear.addEventListener("click", () => {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(s => {
                    stream = s;
                    videoElement.srcObject = stream;
                    videoElement.style.display = "block";
                    videoElement.play();
                    btnLinterna.style.display = "inline"; // Mostrar bot칩n de linterna
                    track = stream.getVideoTracks()[0];

                    codeReader.decodeFromVideoDevice(undefined, videoElement, (result, err) => {
                        if (result) {
                            const datos = result.text;
                            resultadoElement.textContent = datos;

                            // Separar los datos por "@"
                            const partes = datos.split("@");

                            if (partes.length >= 9) {
                                const nroTramite = partes[0];
                                const apellido = partes[1];
                                const nombre = partes[2];
                                const sexo = partes[3];
                                const dni = partes[4];
                                const ejemplar = partes[5];
                                const fechaNacimiento = partes[6];
                                const fechaEmision = partes[7];
                                const dniUltimoDato = partes[8];

                                // Asignar valores a las variables
                                apellidoElement.textContent = apellido;
                                nombreElement.textContent = nombre;
                                dniElement.textContent = dni;
                                fechaEmisionElement.textContent = fechaEmision;
   
                                console.log("N칰mero de Tr치mite:", nroTramite);
                                console.log("Apellido:", apellido);
                                console.log("Nombre:", nombre);
                                console.log("Sexo:", sexo);
                                console.log("DNI:", dni);
                                console.log("Ejemplar:", ejemplar);
                                console.log("Fecha de Nacimiento:", fechaNacimiento);
                                console.log("Fecha de Emisi칩n:", fechaEmision);
                                console.log("칔ltimo Dato:", dniUltimoDato);
                            } else {
                                console.error("Formato de datos incorrecto.");
                            }

                            // Detener la c치mara despu칠s de escanear
                            detenerEscaneo();

                            // Apagar la linterna si est치 encendida
                            if (track && linternaEncendida) {
                                track.applyConstraints({ advanced: [{ torch: false }] })
                                    .then(() => {
                                        linternaEncendida = false;
                                        console.log("Linterna apagada despu칠s del escaneo.");
                                    })
                                    .catch(err => console.error("No se pudo apagar la linterna:", err));
                            }
                        }
                    });
                })
                .catch(err => console.error("Error accediendo a la c치mara:", err));
        });

        btnLinterna.addEventListener("click", () => {
            if (track) {
                linternaEncendida = !linternaEncendida;
                track.applyConstraints({ advanced: [{ torch: linternaEncendida }] })
                    .then(() => console.log(`Linterna ${linternaEncendida ? "encendida" : "apagada"}`))
                    .catch(err => console.error("No se pudo activar la linterna:", err));
            }
        });

        function detenerEscaneo() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
            }
            videoElement.style.display = "none";
            btnLinterna.style.display = "none";
            linternaEncendida = false;
        }
    </script>
</body>
</html>

