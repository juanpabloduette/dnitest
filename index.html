<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script src="https://cdn.jsdelivr.net/npm/signature_pad"></script>
		<title>Entregar Certificado - Narvaezbid</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 0;
				padding: 0;
				background-color: #1c1c3c;
				color: #dfdfdf;
			}
			h2 {
				text-align: center;
				margin: 10px 0 0 0;
			}
			.campos {
				margin: 10px;
				padding: 10px;
				background-color: #2c2c5c;
				border-radius: 10px;
				font-size: 25px;
			}
			#video-container {
				position: relative;
				display: inline-block;
				display: flex;
				justify-content: center;
				align-items: center;
			}
			#recuadro {
				position: absolute;
				top: 50%;
				left: 50%;
				width: 250px;
				height: 80px;
				background-color: transparent;
				border: 1px solid white;
				transform: translate(-50%, -50%);
				pointer-events: none;
				display: none;
			}
			video {
				/* display: block;
				width: 100%;
				height: 350px;
				max-width: 350px; */

				display: block;
				width: 100%;
				height: auto;
				max-width: 400px; /* Aumentamos el ancho máximo */
				max-height: 250px; /* Reducimos la altura */
				object-fit: cover;
			}
			.buttons {
				display: flex;
				justify-content: center;
				align-items: center;
			}
			#btnEscanear {
				padding: 10px 10px;
				font-family: Arial, Helvetica, sans-serif;
				background-color: transparent;
				border-radius: 50px;
				border: 1px solid #be00ff;
				transition: all 0.2s ease;
				margin: 5px;
				min-width: 270px;
				cursor: pointer;
				color: white;
				font-size: 35px;
			}

			#btnEscanear:hover,
			#btnInstructivo:hover,
			#btnAceptar:hover,
			#btnBorrar:hover,
			#btnCancelar:hover {
				background-color: #be00ff;
				color: white;
			}
			#btnEscanear,
			#btnLinterna {
				margin: 5px;
			}
			#btnLinterna {
				padding: 10px 10px;
				font-family: Arial, Helvetica, sans-serif;
				background-color: transparent;
				border-radius: 50px;
				border: 1px solid #be00ff;
				transition: all 0.2s ease;
				margin: 5px;
				cursor: pointer;
				color: white;
				font-size: 35px;
			}
			.btnInstructivo-box {
				display: flex;
				justify-content: center;
			}
			#btnInstructivo,
			#btnAceptar,
			#btnBorrar,
			#btnCancelar {
				padding: 10px 10px;
				font-family: Arial, Helvetica, sans-serif;
				background-color: transparent;
				border-radius: 50px;
				border: 1px solid #be00ff;
				transition: all 0.2s ease;
				margin: 5px;
				cursor: pointer;
				color: white;
				font-size: 16px;
			}
			/* MODAL */
			.modal {
				display: none;
				position: fixed;
				z-index: 1;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				overflow: auto;
				background-color: rgba(0, 0, 0, 0.7);
			}
			.modal-content {
				background-color: #2c2c5c;
				margin: 15% auto;
				padding: 20px;
				border: 1px solid #be00ff;
				width: 80%;
				max-width: 500px;
				text-align: center;
				border-radius: 10px;
			}
			.close {
				color: #aaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
				cursor: pointer;
			}
			.close:hover,
			.close:focus {
				color: white;
				text-decoration: none;
			}
			.modal img {
				width: 100%;
				border-radius: 10px;
			}

			/* Firma */
			#signature-container {
				display: none;
				/* border: 2px solid #000; */
				width: 100%;
				max-width: 370px;
				margin: 5px;
				padding: 5px;
				text-align: center;
				background-color: #2c2c5c;
				justify-content: center;
				align-items: center;
				flex-direction: column;
				margin: 0 auto;
				border-radius: 10px;
			}
			#signature-pad {
				border: 1px solid #be00ff;
				width: 100%;
				height: 220px;
			}
			#firma-guardada {
				margin-top: 0px;
				display: none;
			}
		</style>
	</head>
	<body>
		<h2>Entregar certificado de Subasta</h2>
		<div class="btnInstructivo-box">
			<button id="btnInstructivo">Instructivo</button>
		</div>

		<div id="video-container">
			<video id="video" style="display: none" autoplay></video>
			<div id="recuadro"></div>
		</div>

		<div class="campos">
			<!-- <p><strong>Resultado:</strong> <span id="resultado"></span></p> -->
			<p><strong>Apellido:</strong> <span id="apellido"></span></p>
			<p><strong>Nombre:</strong> <span id="nombre"></span></p>
			<p><strong>DNI:</strong> <span id="dni"></span></p>
			<!-- <p><strong>Fecha Emisión:</strong> <span id="fechaEmision"></span></p> -->
			<!-- Imagen de la firma guardada -->
			<div id="firma-guardada">
				<h4>Firma:</h4>
				<img id="firma-imagen" src="" alt="Firma guardada" />
			</div>
		</div>
		<div class="buttons">
			<button id="btnEscanear">Escanear DNI</button>
			<button id="btnLinterna" style="display: none">🔦</button>
		</div>
		<!-- Contenedor de firma -->
		<div id="signature-container">
			<h3>Firma Digital</h3>
			<canvas id="signature-pad"></canvas>
			<div class="buttons">
				<button id="btnAceptar">Aceptar</button>
				<button id="btnBorrar">Borrar</button>
				<!-- <button id="btnCancelar">Cancelar</button> -->
			</div>
		</div>

		<div id="modal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<img src="dniformat.png" alt="Instructivo" />
			</div>
		</div>
		<script type="module">
			import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm";

			const codeReader = new BrowserMultiFormatReader();
			const videoElement = document.getElementById("video");
			const resultadoElement = document.getElementById("resultado");
			const btnEscanear = document.getElementById("btnEscanear");
			const btnLinterna = document.getElementById("btnLinterna");
			const recuadro = document.getElementById("recuadro");

			const apellidoElement = document.getElementById("apellido");
			const nombreElement = document.getElementById("nombre");
			const dniElement = document.getElementById("dni");
			const fechaEmisionElement = document.getElementById("fechaEmision");

			let stream = null;
			let track = null;
			let linternaEncendida = false;

			btnEscanear.addEventListener("click", () => {
				navigator.mediaDevices
					.getUserMedia({
						video: {
							facingMode: "environment",
							width: { ideal: 1920 }, // Aumenta la resolución
							height: { ideal: 1080 },
						},
					})
					.then((s) => {
						stream = s;
						videoElement.srcObject = stream;
						videoElement.style.display = "block";
						videoElement.play();
						btnLinterna.style.display = "inline";
						track = stream.getVideoTracks()[0];
						recuadro.style.display = "block";

						codeReader.decodeFromVideoDevice(
							undefined,
							videoElement,
							(result, err) => {
								if (result) {
									const datos = result.text;  // El texto del QR
                                    const partes = datos.split("@");

                                    // Creamos un objeto para almacenar los valores detectados
                                    let apellido = '';
                                    let nombre = '';
                                    let dni = '';
                                    let fechaNacimiento = '';
                                    let fechaEmision = '';
                                    let codigoExtra = '';  // El campo adicional en el segundo formato

                                    // Verificamos cuántas partes tiene el array
                                    if (partes.length === 8) {
                                    // Caso 1: Formato con 8 partes
                                    apellido = partes[1] || "Apellido no detectado";
                                    nombre = partes[2] || "Nombre no detectado";
                                    dni = partes[4] || "DNI no detectado";
                                    fechaNacimiento = partes[6] || "Fecha de nacimiento no disponible";
                                    fechaEmision = partes[7] || "Fecha de emisión no disponible";
                                    } else if (partes.length === 9) {
                                    // Caso 2: Formato con 9 partes
                                    apellido = partes[1] || "Apellido no detectado";
                                    nombre = partes[2] || "Nombre no detectado";
                                    dni = partes[4] || "DNI no detectado";
                                    fechaNacimiento = partes[6] || "Fecha de nacimiento no disponible";
                                    fechaEmision = partes[7] || "Fecha de emisión no disponible";
                                    codigoExtra = partes[8] || "Código adicional no disponible";
                                    } else {
                                    console.error("Formato del código QR inesperado");
                                    }

                                    // Mostrar los resultados
                                    apellidoElement.textContent = apellido;
                                    nombreElement.textContent = nombre;
                                    dniElement.textContent = dni;
                                    // fechaEmisionElement.textContent = fechaEmision;
                                    // document.getElementById("fechaNacimiento").textContent = fechaNacimiento;

                                    // Si hay un código extra en el segundo formato, lo mostramos
                                    if (codigoExtra) {
                                    console.log("Código adicional:", codigoExtra);
                                    }


									console.log("Código detectado:", datos);
									detenerEscaneo();
									codeReader.reset();
									document.getElementById("signature-container").style.display = "flex";
								}
							}
						);
					})
					.catch((err) => console.error("Error accediendo a la cámara:", err));
			});

			btnLinterna.addEventListener("click", () => {
				if (track) {
					linternaEncendida = !linternaEncendida;
					track
						.applyConstraints({ advanced: [{ torch: linternaEncendida }] })
						.then(() =>
							console.log(`Linterna ${linternaEncendida ? "encendida" : "apagada"}`)
						)
						.catch((err) => console.error("No se pudo activar la linterna:", err));
				}
			});

			function detenerEscaneo() {
				if (stream) {
					stream.getTracks().forEach((track) => track.stop());
					stream = null;
				}

				videoElement.srcObject = null;
				videoElement.style.display = "none";
				btnLinterna.style.display = "none";
				btnEscanear.style.display = "none";
				linternaEncendida = false;
				recuadro.style.display = "none";
				console.log("Cámara apagada y escaneo detenido.");
				// alert("Escaneo completado, cámara apagada.");
			}

			document
				.getElementById("btnInstructivo")
				.addEventListener("click", function () {
					document.getElementById("modal").style.display = "block";
				});

			document.querySelector(".close").addEventListener("click", function () {
				document.getElementById("modal").style.display = "none";
			});

			window.addEventListener("click", function (event) {
				if (event.target === document.getElementById("modal")) {
					document.getElementById("modal").style.display = "none";
				}
			});

			// Firma

            document.getElementById("btnAceptar").addEventListener("click", saveSignature);
            document.getElementById("btnBorrar").addEventListener("click", clearSignature);
            // document.getElementById("btnCancelar").addEventListener("click", quitSignature);
			let signaturePad;
			let firmaBase64 = "";

			window.onload = function () {
				const canvas = document.getElementById("signature-pad");
				signaturePad = new SignaturePad(canvas, {
					backgroundColor: "transparent",
					penColor: "#dfdfdf", // Cambio de color del trazo
				});
			};

			function resizeCanvas() {
    const canvas = document.getElementById("signature-pad");
    const ctx = canvas.getContext("2d");

    // Obtener el ancho visible del canvas
    const width = canvas.offsetWidth;

    // Definir un alto fijo (220px)
    const height = 220;

    // Obtener la densidad de píxeles del dispositivo
    const ratio = window.devicePixelRatio || 1;

    // Ajustar el tamaño real del canvas según la densidad de píxeles
    canvas.width = width * ratio;
    canvas.height = height * ratio;

    // Ajustar el tamaño visible del canvas
    canvas.style.width = `${width}px`;
    canvas.style.height = `${height}px`;

    // Corregir la escala del contexto de dibujo para que se ajuste correctamente
    ctx.scale(ratio, ratio);

    // Si hay una firma, restaurarla
    signaturePad.clear();
    signaturePad.fromData(signaturePad.toData());
}

// Llamamos a la función cuando se cargue la página o al redimensionar la ventana
window.addEventListener("resize", resizeCanvas);
resizeCanvas();


// Asegúrate de llamar a resizeCanvas cuando se carga la página o cuando se redimensiona la ventana
window.addEventListener("resize", resizeCanvas);
resizeCanvas();


			// Borrar firma
			function clearSignature() {
				signaturePad.clear();
			}

			// Guardar firma
			function saveSignature() {
				if (!signaturePad.isEmpty()) {
					firmaBase64 = signaturePad.toDataURL();
					document.getElementById("firma-imagen").src = firmaBase64;
					document.getElementById("firma-guardada").style.display = "block";
					document.getElementById("signature-container").style.display = "none";
				} else {
					alert("Debes firmar antes de aceptar.");
				}
			}

            function quitSignature() {
                document.getElementById("signature-container").style.display = "none";
            }

		</script>
	</body>
</html>
