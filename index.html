<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escáner DNI Argentina</title>
    <style>
        #video-container {
            position: relative;
            display: inline-block;
        }
        #recuadro {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300px;
            height: 100px;
            background-color: transparent;
            border: 1px solid white;
            transform: translate(-50%, -50%);
            pointer-events: none; /* Esto asegura que el recuadro no interfiera con el video */
            display: none; /* Inicialmente el recuadro está oculto */
        }
        video {
            display: block;
            width: 100%;
            max-width: 450px;
        }
    </style>
</head>
<body>
    <h2>Escanea el código del DNI</h2>
    <button id="btnEscanear">Escanear DNI</button>
    <button id="btnLinterna" style="display: none;">🔦 Linterna</button>
    <div id="video-container">
        <video id="video" style="display: none;" autoplay></video>
        <div id="recuadro"></div>
    </div>
    <p><strong>Resultado:</strong> <span id="resultado"></span></p>
    <p><strong>Apellido:</strong> <span id="apellido"></span></p>
    <p><strong>Nombre:</strong> <span id="nombre"></span></p>
    <p><strong>DNI:</strong> <span id="dni"></span></p>
    <p><strong>Fecha Emisión:</strong> <span id="fechaEmision"></span></p>

    <script type="module">
        import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm';

        const codeReader = new BrowserMultiFormatReader();
        const videoElement = document.getElementById("video");
        const resultadoElement = document.getElementById("resultado");
        const btnEscanear = document.getElementById("btnEscanear");
        const btnLinterna = document.getElementById("btnLinterna");
        const recuadro = document.getElementById("recuadro");

        // Elementos donde se mostrarán los valores extraídos
        const apellidoElement = document.getElementById("apellido");
        const nombreElement = document.getElementById("nombre");
        const dniElement = document.getElementById("dni");
        const fechaEmisionElement = document.getElementById("fechaEmision");

        let stream = null;
        let track = null;
        let linternaEncendida = false;

        btnEscanear.addEventListener("click", () => {
            recuadro.style.display = "block"; // Mostrar el recuadro al empezar a escanear
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(s => {
                    stream = s;
                    videoElement.srcObject = stream;
                    videoElement.style.display = "block";
                    videoElement.play();
                    btnLinterna.style.display = "inline"; // Mostrar botón de linterna
                    track = stream.getVideoTracks()[0];

                    codeReader.decodeFromVideoDevice(undefined, videoElement, (result, err) => {
                        if (result) {
                            const datos = result.text;
                            resultadoElement.textContent = datos;

                            // Separar los datos por "@"
                            const partes = datos.split("@");

                            if (partes.length >= 9) {
                                const nroTramite = partes[0];
                                const apellido = partes[1];
                                const nombre = partes[2];
                                const sexo = partes[3];
                                const dni = partes[4];
                                const ejemplar = partes[5];
                                const fechaNacimiento = partes[6];
                                const fechaEmision = partes[7];
                                const dniUltimoDato = partes[8];

                                // Asignar valores a las variables
                                apellidoElement.textContent = apellido;
                                nombreElement.textContent = nombre;
                                dniElement.textContent = dni;
                                fechaEmisionElement.textContent = fechaEmision;
   
                                console.log("Número de Trámite:", nroTramite);
                                console.log("Apellido:", apellido);
                                console.log("Nombre:", nombre);
                                console.log("Sexo:", sexo);
                                console.log("DNI:", dni);
                                console.log("Ejemplar:", ejemplar);
                                console.log("Fecha de Nacimiento:", fechaNacimiento);
                                console.log("Fecha de Emisión:", fechaEmision);
                                console.log("Último Dato:", dniUltimoDato);
                            } else {
                                console.error("Formato de datos incorrecto.");
                            }

                            // Detener la cámara después de escanear
                            detenerEscaneo();

                            // Apagar la linterna si está encendida
                            if (track && linternaEncendida) {
                                track.applyConstraints({ advanced: [{ torch: false }] })
                                    .then(() => {
                                        linternaEncendida = false;
                                        console.log("Linterna apagada después del escaneo.");
                                    })
                                    .catch(err => console.error("No se pudo apagar la linterna:", err));
                            }

                            // Ocultar el recuadro después de encontrar el escaneo
                            recuadro.style.display = "none";
                        }
                    });
                })
                .catch(err => console.error("Error accediendo a la cámara:", err));
        });

        btnLinterna.addEventListener("click", () => {
            if (track) {
                linternaEncendida = !linternaEncendida;
                track.applyConstraints({ advanced: [{ torch: linternaEncendida }] })
                    .then(() => console.log(`Linterna ${linternaEncendida ? "encendida" : "apagada"}`))
                    .catch(err => console.error("No se pudo activar la linterna:", err));
            }
        });

        function detenerEscaneo() {
    if (stream) {
        stream.getTracks().forEach(track => {
            track.stop();  // Detenemos cada pista de video/audio
            stream.removeTrack(track);  // Eliminamos la pista del stream
        });
        stream = null;
    }

    // Limpiar el objeto del video completamente
    videoElement.srcObject = null;
    videoElement.removeAttribute("src");
    videoElement.style.display = "none";
    videoElement.load();  // Recargar el elemento de video

    // Ocultar botones
    btnLinterna.style.display = "none";
    linternaEncendida = false;

    // 🚀 **FORZAR CIERRE DE LA CÁMARA** 🚀
    setTimeout(() => {
        navigator.mediaDevices.getUserMedia({ video: true })  // Pedimos acceso de nuevo
            .then(newStream => {
                newStream.getTracks().forEach(track => track.stop()); // Lo cerramos inmediatamente
            })
            .catch(err => console.log("Error liberando cámara:", err));
    }, 1000);  // Pequeña espera para que el navegador detecte el cambio

    console.log("Cámara apagada y acceso revocado.");
    alert("Camara apagada?")
}


    </script>
</body>
</html>


